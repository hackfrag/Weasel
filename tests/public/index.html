
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
	<head>
		<title>MoveDemo</title>
		<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-15">
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js" type="text/javascript"></script>
		<script type="text/javascript" src="/vendor/socket.io.js"> </script>
		<script type="text/javascript" src="/lib/weasel.js"> </script>
		
	
		
		<link rel="stylesheet" type="text/css" href="style.css" />


		<script type="text/javascript" language="client">

			var Example = {
			
			
				createClient : function(client) {
					var point = $('<div>');
			
					point.attr('id', 'point-' + client.sessionId);
					point.attr('class', 'box');
					point.css({
						'top' 		: client.position.top,
						'left'		: client.position.left,
					});
			
					point.html('<div class="message"></div>');
			
					return point;
				},
				chat: function(params) {
					var bubble = $('#point-' + params.sessionId + ' > div.message');
					
					bubble.stop().hide();
					bubble.html(params.message);
					bubble.fadeIn('fast', function() {
						$(this).fadeOut(2000)
					})
				},
				move : function(params) {
					var bubble = $('#point-' + params.sessionId);
					
					bubble.animate({ 
						top:  params.position.top,
						left:  params.position.left,
					}, 500 );
				
				}
				
			}
						

			Weasel.subscribe('connect', function(params) {
				var point = Example.createClient(params.client);
				$('#movebox').append(point);
			})
			Weasel.subscribe('disconnect', function(params) {
				$('#point-' + params.client.sessionId).hide();
			})
			Weasel.subscribe('chat', Example.chat);
			
			Weasel.subscribe('move', Example.move);
				
				
			
			Weasel.ready(function() {
				
				
				var point = Example.createClient(Weasel.Client);
				point.addClass('client');
				$('#movebox').append(point);
				
				$('#movebox').click(function(e){
					
					var divPos = $('#movebox').position(),
						newPostion = {top: e.pageY-divPos.top - 25, left: e.pageX-divPos.left - 25};
					
					Weasel.command("move", newPostion, function(params) {
						
						Example.move({
							sessionId : Weasel.Client.sessionId,
							position: newPostion
						})
												
					
					})
				})
				
				
				Weasel.command("getAllClients", function(params) {
				
					params.clients.forEach(function(client) {
						point = Example.createClient(client);
						$('#movebox').append(point);
					})
				});
				
				
				$('#chat-form').submit(function() {
					Weasel.command("chat", {message: $('#chat_message').val()} ,function(params) {
						Example.chat({
							message : $('#chat_message').val(),
							sessionId : Weasel.Client.sessionId
						});
						$('#chat_message').val("")
					});
					return false;
				})
				
				

			});
			
		
		</script>
	</head>
	<body>
		<div id="wrapper">
			<div id="movebox">
				
			</div>
			<form id="chat-form">
				
			
				<input type="text" class="text" name="chat" id="chat_message">
				<input type="submit" class="submit" name="submit" value="Send" id="chat_submit">
			</form>
		</div>


	</body>

</html>
